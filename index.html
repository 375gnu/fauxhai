<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Fauxhai by customink</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Fauxhai</h1>
        <p class="header">Easily mock full ohai data</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/customink/fauxhai/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/customink/fauxhai/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/customink/fauxhai">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/customink">customink</a></p>


      </header>
      <section>
        <h1>Fauxhai</h1>

<p>Fauxhai is a gem for mocking out <a href="https://github.com/opscode/ohai">ohai</a> data in your chef testing. Fauxhai is community supported, so we need <strong>your help</strong> to populate our dataset. Here's an example for testing my "awesome_cookbook" on Ubuntu:</p>

<p><strong>Fauxhai is still in alpha stages and should not be considered stable! Pull Requests and feedback are welcome :)</strong></p>

<div class="highlight">
<pre><span class="nb">require</span> <span class="s1">'chefspec'</span>

<span class="n">describe</span> <span class="s1">'awesome_cookbook::default'</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="no">Fauxhai</span><span class="o">.</span><span class="n">mock</span><span class="p">(</span><span class="n">platform</span><span class="ss">:'ubuntu'</span><span class="p">,</span> <span class="n">version</span><span class="ss">:'12.04'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'should install awesome'</span> <span class="k">do</span>
    <span class="vi">@runner</span> <span class="o">=</span> <span class="no">ChefSpec</span><span class="o">::</span><span class="no">ChefRunner</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">converge</span><span class="p">(</span><span class="s1">'tmpreaper::default'</span><span class="p">)</span>
    <span class="vi">@runner</span><span class="o">.</span><span class="n">should</span> <span class="n">install_package</span> <span class="s1">'awesome'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>Alternatively, you can pull "real" ohai data from an existing server:</p>

<div class="highlight">
<pre><span class="nb">require</span> <span class="s1">'chefspec'</span>

<span class="n">describe</span> <span class="s1">'awesome_cookbook::default'</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="no">Fauxhai</span><span class="o">.</span><span class="n">mock</span><span class="p">(</span><span class="n">url</span><span class="ss">:'server01.example.com'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'should install awesome'</span> <span class="k">do</span>
    <span class="vi">@runner</span> <span class="o">=</span> <span class="no">ChefSpec</span><span class="o">::</span><span class="no">ChefRunner</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">converge</span><span class="p">(</span><span class="s1">'tmpreaper::default'</span><span class="p">)</span>
    <span class="vi">@runner</span><span class="o">.</span><span class="n">should</span> <span class="n">install_package</span> <span class="s1">'awesome'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>Fauxhai supports <a href="https://github.com/acrmp/chefspec">ChefSpec</a> and <a href="https://github.com/calavera/rspec-chef">rspec-chef</a>. In order to prevent polluting the README, only ChefSpec examples will be provided. However, there is an extensive README for each testing framework in the <a href="https://github.com/customink/fauxhai/tree/master/examples">examples</a> directory.</p>

<h2>Important Note</h2>

<p>Fauxhai ships with a command line tool - <code>fauxhai</code>. This is <strong>not</strong> the same as Fauxhai.mock. Running <code>fauxhai</code> on a machine effectively runs <code>ohai</code>, but then sanitizes the data, removing/replacing things like:</p>

<ul>
<li>users</li>
<li>ssh keys</li>
<li>usernames in paths</li>
<li>sensitive system information</li>
</ul><p><code>fauxhai</code> should only be used by developers wishing to submit a new json file.</p>

<h2>Usage</h2>

<p>Fauxhai provides a bunch of default attributes so that you don't need to mock out your entire infastructure to write a simple test. That being said, not all configurations will suit your needs. Because of that, Fauxhai provides two ways to configure your mocks:</p>

<h3>Overriding</h3>

<p><code>Fauxhai.mock</code> will also accept a block with override attributes that are merged with all the default attributes. For example, the default Ubutnu 12.04 mock uses <code>Ruby 1.9.3</code>. Maybe your system is using <code>ree</code>, and you want to verify that the cookbooks work with that data as well:</p>

<div class="highlight">
<pre><span class="nb">require</span> <span class="s1">'chefspec'</span>

<span class="n">describe</span> <span class="s1">'awesome_cookbook::default'</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="no">Fauxhai</span><span class="o">.</span><span class="n">mock</span><span class="p">(</span><span class="n">platform</span><span class="ss">:'ubuntu'</span><span class="p">,</span> <span class="n">version</span><span class="ss">:'12.04'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
      <span class="n">node</span><span class="o">[</span><span class="s1">'languages'</span><span class="o">][</span><span class="s1">'ruby'</span><span class="o">][</span><span class="s1">'version'</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'ree'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'should install awesome'</span> <span class="k">do</span>
    <span class="vi">@runner</span> <span class="o">=</span> <span class="no">ChefSpec</span><span class="o">::</span><span class="no">ChefRunner</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">converge</span><span class="p">(</span><span class="s1">'tmpreaper::default'</span><span class="p">)</span>
    <span class="vi">@runner</span><span class="o">.</span><span class="n">should</span> <span class="n">install_package</span> <span class="s1">'awesome'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>The <code>node</code> block variable allows you to set any Ohai attribute on the mock that you want. This provides an easy way to manage your environments. If you find that you are overridding attributes like OS or platform, you should see the section on Contributing.</p>

<h3>Fetching</h3>

<p>Alternatively, if you do not want to mock the data, Fauxhai provides a <code>fetch</code> mechanism for collecting "real" ohai data from a remote server or local file. Maybe you want to test against the fully-replicated environment for a front-facing server in your pool. Just pass in the <code>url</code> option instead of a <code>platform</code>:</p>

<div class="highlight">
<pre><span class="nb">require</span> <span class="s1">'chefspec'</span>

<span class="n">describe</span> <span class="s1">'awesome_cookbook::default'</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="no">Fauxhai</span><span class="o">.</span><span class="n">mock</span><span class="p">(</span><span class="n">url</span><span class="ss">:'server01.example.com'</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'should install awesome'</span> <span class="k">do</span>
    <span class="vi">@runner</span> <span class="o">=</span> <span class="no">ChefSpec</span><span class="o">::</span><span class="no">ChefRunner</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">converge</span><span class="p">(</span><span class="s1">'tmpreaper::default'</span><span class="p">)</span>
    <span class="vi">@runner</span><span class="o">.</span><span class="n">should</span> <span class="n">install_package</span> <span class="s1">'awesome'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<p>This will ssh into the machine (you must have authorization to run <code>sudo ohai</code> on that machine), download a copy of the ohai output, and optionally cache that data inside the test directory (speeding up future tests).</p>

<h3>Overriding + Fetching</h3>

<p>As you might expect, you can combine overriding and fetching like so:</p>

<div class="highlight">
<pre><span class="nb">require</span> <span class="s1">'chefspec'</span>

<span class="n">describe</span> <span class="s1">'awesome_cookbook::default'</span> <span class="k">do</span>
  <span class="n">before</span> <span class="k">do</span>
    <span class="no">Fauxhai</span><span class="o">.</span><span class="n">mock</span><span class="p">(</span><span class="n">url</span><span class="ss">:'server01.example.com'</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
      <span class="n">node</span><span class="o">[</span><span class="s1">'languages'</span><span class="o">][</span><span class="s1">'ruby'</span><span class="o">][</span><span class="s1">'version'</span><span class="o">]</span> <span class="o">=</span> <span class="s1">'ree'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'should install awesome'</span> <span class="k">do</span>
    <span class="vi">@runner</span> <span class="o">=</span> <span class="no">ChefSpec</span><span class="o">::</span><span class="no">ChefRunner</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">converge</span><span class="p">(</span><span class="s1">'tmpreaper::default'</span><span class="p">)</span>
    <span class="vi">@runner</span><span class="o">.</span><span class="n">should</span> <span class="n">install_package</span> <span class="s1">'awesome'</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>


<h2>Contributing</h2>

<p>Fauxhai is community-maintained and updated. Aside from the initial files, all of the ohai system mocks have been created by the community. If you have a system that you think would benefit the community, here's how you get it into <a href="https://github.com/customink/fauxhai">fauxhai</a>:</p>

<ol>
<li>Build a system to your liking (on a virtual machine, for example)</li>
<li>Install chef, ohai, and fauxhai</li>
<li>
<p>Run the following at the command line:</p>

<pre><code>sudo fauxhai
</code></pre>
</li>
<li><p>This will create a file <code>/tmp/fauxhai.json</code></p></li>
<li><p>Copy the contents of this file to your local development machine (using scp or sftp, for example)</p></li>
<li>
<p>Clone and <code>bundle</code> this repo:</p>

<pre><code>git clone git@github.com:customink/fauxhai.git
cd fauxhai
bundle
</code></pre>
</li>
<li>
<p>Create a new branch named <code>add_[platform]_[version]</code> (e.g. <code>add_ubuntu_12_04</code>) without dashes and dots replaced with underscores. Be sure to use the official version number, not a package name (e.g. '12_04', not 'precise') if avaliable:</p>

<pre><code>Ubuntu Precise, 12.04       add_ubuntu_12_04
Ubuntu Lucid, 11.5          add_ubuntu_11_5
OSX Lion, 10.7.4            add_osx_10_7_4
Windows XP                  add_windows_xp
</code></pre>

<p><strong>Q:</strong> Is there a reason for this super-specific naming convention?
<strong>A:</strong> No, but it helps in tracking problems and analyzing pull requests. Ultimately it just ensures your pull request is merged as quickly as possible.</p>
</li>
<li><p>Create a new json file in <code>fauxhai/[os]/[version].json</code> (e.g. <code>fauxhai/ubuntu/12_04.json</code>)</p></li>
<li><p>Copy-paste the contents of the file from <code>Step 4</code> into this file and save</p></li>
<li>
<p>Verify the installation was successful by doing the following:</p>

<pre><code>irb -rubygems -rfauxhai
Fauxhai.mock('[os]', '[version') # e.g. Fauxhai.mock('ubuntu', '12.04')
</code></pre>

<p>As long as that does not throw an error, you're good to go!</p>
</li>
<li><p>Submit a pull request on github</p></li>
</ol>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
		
  </body>
</html>